<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='kubernetes101 ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE express-app NodePort 10.0.0.151 &lt;none&gt; 80:31530/TCP 19m kubernetes ClusterIP 10.0.0.1 &lt;none&gt; 443/TCP 1d è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ NodeIP:NodePort æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ª Node èŠ‚ç‚¹çš„ IP
$ curl http://192.168.99.100:31530 hello world ä½†æ¯æ¬¡ä½¿ç”¨ IP&#43;Port è®¿é—®æœåŠ¡çš„æ–¹å¼å¾ˆä¸æ–¹ä¾¿ã€‚åœ¨å•æœºä¸Šï¼Œå¯ä»¥ä½¿ç”¨ nginx çš„åå‘ä»£ç†ï¼Œå®ç°é€šè¿‡åŸŸåè®¿é—®æœåŠ¡ã€‚
nginx.conf
http { upstream my-api { server 127.0.0.1:8080; } server { listen 80; server_name api.domain.com; location / { proxy_pass http://my-api; } } } å¯ç”¨ nginx åï¼Œå°±å¯ä»¥é€šè¿‡è®¿é—® http://api.'>

<meta property='og:title' content='Kubernetes Ingress â€¢ ccccly'>
<meta property='og:description' content='kubernetes101 ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE express-app NodePort 10.0.0.151 &lt;none&gt; 80:31530/TCP 19m kubernetes ClusterIP 10.0.0.1 &lt;none&gt; 443/TCP 1d è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ NodeIP:NodePort æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ª Node èŠ‚ç‚¹çš„ IP
$ curl http://192.168.99.100:31530 hello world ä½†æ¯æ¬¡ä½¿ç”¨ IP&#43;Port è®¿é—®æœåŠ¡çš„æ–¹å¼å¾ˆä¸æ–¹ä¾¿ã€‚åœ¨å•æœºä¸Šï¼Œå¯ä»¥ä½¿ç”¨ nginx çš„åå‘ä»£ç†ï¼Œå®ç°é€šè¿‡åŸŸåè®¿é—®æœåŠ¡ã€‚
nginx.conf
http { upstream my-api { server 127.0.0.1:8080; } server { listen 80; server_name api.domain.com; location / { proxy_pass http://my-api; } } } å¯ç”¨ nginx åï¼Œå°±å¯ä»¥é€šè¿‡è®¿é—® http://api.'>
<meta property='og:url' content='http://excited-ccccly.github.io/studymakesmehappy.club/posts/kubernetes-ingress/'>
<meta property='og:site_name' content=''>
<meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='Kubernetes'><meta property='article:tag' content='Ingress'><meta property='article:tag' content='nginx'><meta property='article:tag' content='Loadbalancer'><meta property='article:published_time' content='2018-03-27T15:27:27&#43;08:00'/><meta property='article:modified_time' content='2018-03-27T15:27:27&#43;08:00'/>

<meta name="generator" content="Hugo 0.40.2" />

  <base href='http://excited-ccccly.github.io/studymakesmehappy.club/'>
  <title>Kubernetes Ingress â€¢ ccccly</title>
  <link rel='canonical' href='http://excited-ccccly.github.io/studymakesmehappy.club/posts/kubernetes-ingress/'>
  <link href='' rel='alternate' type='application/rss+xml' title='' />
  <link rel='icon' href='http://excited-ccccly.github.io/studymakesmehappy.club/favicon.ico'>
<link rel='stylesheet' href='https://fonts.lug.ustc.edu.cn/css?family=Ubuntu:400,400i,700&subset=latin'>
<link rel='stylesheet' href='http://excited-ccccly.github.io/studymakesmehappy.club/css/main.d02777fd.css'>



</head>


<body class='page'>
  <div class='site'>
    <header id='header' class='header-container'>
      <div class='site-header'>
        <nav id='navmenu' aria-label='Main Menu'>
  <ul class='main-menu'>
    
    <li>
      <a href='http://excited-ccccly.github.io/studymakesmehappy.club/'>Home</a>
    </li>
    
    <li>
      <a href='http://excited-ccccly.github.io/studymakesmehappy.club/about/'>About</a>
    </li>
    
    <li>
      <a href='https://github.com/Excited-ccccly/studymakesmehappy.club'>Repo</a>
    </li>
    
  </ul>
</nav>

        <div class='site-info'>
          
          <p class='site-title title'></p>
          
          <p class='site-description'>Study makes me happy</p>
        </div>
      </div>
    </header>


<main class='main'>
  <article lang='en' class='entry'>
    <header class='entry-header'>
  <div class='entry-info'>
    <h1 class='entry-title title'>Kubernetes Ingress</h1>
    
  </div>
  
<div class='meta'>
  <span class='posted-on'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>

    <span class='screen-reader'>Posted on </span>
    <time class='date' datetime='2018-03-27T15:27:27&#43;08:00'>2018, Mar 27</time>
  </span>
  
  <span class='byline'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>

    <span class='screen-reader'> by </span>
    ccccly
  </span>
  
</div>


</header>

    <div class='entry-content'>
  

<p><a href="http://studymakesmehappy.club/posts/kubernetes101/">kubernetes101</a> ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
express-app   NodePort    <span style="color:#3677a9">10</span>.0.0.151   &lt;none&gt;        <span style="color:#3677a9">80</span>:31530/TCP   19m
kubernetes    ClusterIP   <span style="color:#3677a9">10</span>.0.0.1     &lt;none&gt;        <span style="color:#3677a9">443</span>/TCP        1d</code></pre></div>
<p>è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ <strong>NodeIP:NodePort</strong> æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ª Node èŠ‚ç‚¹çš„ IP</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl http://192.168.99.100:31530
hello world</code></pre></div>
<p>ä½†æ¯æ¬¡ä½¿ç”¨ IP+Port è®¿é—®æœåŠ¡çš„æ–¹å¼å¾ˆä¸æ–¹ä¾¿ã€‚åœ¨å•æœºä¸Šï¼Œå¯ä»¥ä½¿ç”¨ nginx çš„åå‘ä»£ç†ï¼Œå®ç°é€šè¿‡åŸŸåè®¿é—®æœåŠ¡ã€‚</p>

<p>nginx.conf</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">http {
  upstream my-api {
    server <span style="color:#3677a9">127</span>.0.0.1:8080;
  }

  server {
    listen <span style="color:#3677a9">80</span>;
    server_name api.domain.com;
    location / {
      proxy_pass http://my-api;
    }
  }
}</code></pre></div>
<p>å¯ç”¨ nginx åï¼Œå°±å¯ä»¥é€šè¿‡è®¿é—® <a href="http://api.domain.com">http://api.domain.com</a> æ¥è®¿é—®è¿™å°æœºå­ä¸Šç›‘å¬ 8080 ç«¯å£çš„æœåŠ¡ã€‚</p>

<p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒIngress å¯ä»¥è¯´æ˜¯å¯¹ nginx çš„æŠ½è±¡ï¼ˆæ¥å£ï¼‰ï¼Œ<a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a> æ˜¯ Ingress çš„ä¸€ç§å®ç°ã€‚</p>

<p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œå‡è®¾ä½ å­¦ä¹ è¿‡ <a href="http://studymakesmehappy.club/posts/kubernetes101/">kubernetes101</a>ï¼Œä½ å°†ä¼šå­¦ä¹ åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<ul>
<li>Ingress ä»‹ç»</li>
<li>Ingress çš„åŸºç¡€é…ç½®</li>
<li>Ingress çš„ TLS é…ç½®</li>
<li>Ingress çš„ basic auth é…ç½®</li>
<li>Ingress çš„å±€é™</li>
</ul>

<h2 id="ingress-ä»‹ç»">Ingress ä»‹ç»</h2>

<p>åœ¨ Kubernetes ä¸­ï¼Œé€šè¿‡ Ingress è®¿é—®åº”ç”¨çš„æµç¨‹å¤§è‡´ä¸Šæ˜¯è¿™æ ·å­çš„</p>

<p><img src="images/kubernetes/ingress/ingress.png" alt="æ±‚æ¨èå¥½ç”¨çš„ç”»å›¾å·¥å…·ï¼ŒVisio å¥½éš¾ç”¨..." /></p>

<p>é™¤äº† Ingress æš´éœ²åœ¨å…¬ç½‘ä¸­ï¼Œå…¶å®ƒæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯å†…ç½‘ IPï¼Œåªå…è®¸å†…ç½‘è®¿é—®ã€‚</p>

<ul>
<li>External LoadBalancer æ˜¯äº‘æœåŠ¡å‚å•†æä¾›çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæ¯”å¦‚ Azure LoadBalancer, AWS ELB ç­‰ã€‚</li>
<li>Ingress Controller æ ¹æ®å®šä¹‰çš„ Ingress è§„åˆ™ï¼Œæ¥è½¬å‘ä¸åŒçš„è¯·æ±‚åˆ°ä¸åŒçš„ Service ä¸Šï¼Œå°±åƒ nginx çš„åå‘ä»£ç†ä¸€æ ·ã€‚</li>
<li>Default Backend æ˜¯é»˜è®¤çš„åç«¯ï¼Œä½†æœ‰ä¸€ä¸ªæœªçŸ¥çš„åŸŸå(ingress ä¸­æ²¡æœ‰å®šä¹‰)çš„è¯·æ±‚è¿‡æ¥ï¼Œå°†ä¼šè¿”å› default backend æä¾›çš„å†…å®¹ã€‚</li>
</ul>

<p>ä¸€ä¸ªç®€å•çš„ Ingress è§„åˆ™é•¿è¿™æ ·å­</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">apiVersion:<span style="color:#666"> </span>v1<span style="color:#666">
</span><span style="color:#666"></span>items:<span style="color:#666">
</span><span style="color:#666"></span>-<span style="color:#666"> </span>apiVersion:<span style="color:#666"> </span>extensions/v1beta1<span style="color:#666">
</span><span style="color:#666">  </span>kind:<span style="color:#666"> </span>Ingress<span style="color:#666">
</span><span style="color:#666">  </span>metadata:<span style="color:#666">
</span><span style="color:#666">    </span>name:<span style="color:#666"> </span>kube-system.ingress<span style="color:#666">
</span><span style="color:#666">    </span>namespace:<span style="color:#666"> </span>kube-system<span style="color:#666">
</span><span style="color:#666">  </span>spec:<span style="color:#666">
</span><span style="color:#666">    </span>rules:<span style="color:#666">
</span><span style="color:#666">    </span>-<span style="color:#666"> </span>host:<span style="color:#666"> </span>website1.domain.com<span style="color:#666">
</span><span style="color:#666">      </span>http:<span style="color:#666">
</span><span style="color:#666">        </span>paths:<span style="color:#666">
</span><span style="color:#666">        </span>-<span style="color:#666"> </span>backend:<span style="color:#666">
</span><span style="color:#666">            </span>serviceName:<span style="color:#666"> </span>website1<span style="color:#666">
</span><span style="color:#666">            </span>servicePort:<span style="color:#666"> </span><span style="color:#3677a9">80</span><span style="color:#666">
</span><span style="color:#666">          </span>path:<span style="color:#666"> </span>/<span style="color:#666">
</span><span style="color:#666"></span>kind:<span style="color:#666"> </span>List</code></pre></div>
<p>æ­¤é¡¹è§„åˆ™å°† website1.domain.com çš„è¯·æ±‚å…¨éƒ¨è½¬å‘åˆ° website1 æœåŠ¡å¯¹åº”çš„ Pod ä¸­ã€‚</p>

<h2 id="ingress-çš„åŸºç¡€é…ç½®">Ingress çš„åŸºç¡€é…ç½®</h2>

<p>æ¥ä¸‹æ¥åŠ¨æ‰‹é…ç½®ä¸€ä¸ª Kubernetes é›†ç¾¤çš„ Ingress</p>

<p>ä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œä»¥ä¸‹æ‰€æœ‰ä½¿ç”¨åˆ°çš„é…ç½®æ–‡ä»¶éƒ½ä½¿ç”¨ç½‘ç»œåœ°å€ï¼Œä¸æ˜¾ç¤ºå®é™…çš„å†…å®¹ï¼Œå¯ä»¥å•ç‹¬ä¸‹è½½æ–‡ä»¶æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥å‰å¾€ <a href="https://github.com/Excited-ccccly/studymakesmehappy.club/tree/master/static/files/kubernetes/ingress">ingress é…ç½®æ–‡ä»¶å¤¹</a> æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶</p>

<ul>
<li>ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬ä¸º Ingress å•ç‹¬åˆ›å»ºä¸€ä¸ª namespace</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/01-namespace.yaml</code></pre></div>
<ul>
<li>åˆ›å»ºé»˜è®¤çš„ http åç«¯ï¼ŒIngress æ¥æ”¶åˆ°ä¸€ä¸ª 404 çš„åœ°å€ï¼Œäº¤ç»™è¿™ä¸ªåç«¯æ¥å¤„ç†</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/02-default-backend.yaml</code></pre></div>
<ul>
<li>åˆ›å»º ingress nginx æ‰€éœ€çš„é…ç½®æ–‡ä»¶ã€‚é»˜è®¤çš„é…ç½®é™åˆ¶ body size ä¸º 1mï¼Œè¿™é‡Œç¨å¾®è°ƒå¤§ä¸€äº›ï¼Œæ–¹ä¾¿æ–‡ä»¶ä¸Šä¼ </li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/03-configmap.yaml</code></pre></div>
<ul>
<li>åˆ›å»º ingress nginx æœåŠ¡</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/04-ingress-nginx.yaml</code></pre></div>
<ul>
<li>é€šè¿‡ LoadBalancer çš„æ–¹å¼å¯¹å¤–æš´éœ² ingress nginx æœåŠ¡</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/05-service.yaml</code></pre></div>
<p>è·å– ingress nginx æœåŠ¡çš„å¤–éƒ¨ LoadBalancer çš„åœ°å€</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">  kubectl get svc -n ingress-nginx</code></pre></div>
<ul>
<li><p>å°†åŸŸåè§£æåˆ°å¤–éƒ¨çš„ LoadBalancer</p>

<p>*.domain -&gt; ExternalLoadBalancerIP</p></li>

<li><p>åˆ›å»ºä¸€æ¡ Ingress è§„åˆ™(æš‚æ—¶ä¸å¸¦ TLS å’Œ Basic Auth)ï¼Œå°† <strong>k8s-dashboard.domain.com</strong> è½¬å‘è‡³ kubernetes-dashboard æœåŠ¡å¯¹åº”çš„ Pod ä¸­ã€‚</p></li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-without-neither-tls-or-basic-auth.yaml</code></pre></div>
<p>ingress-controller ä¼šç›‘å¬é›†ç¾¤ä¸­æ‰€æœ‰ Ingress è§„åˆ™çš„å˜åŠ¨ï¼Œä¿æŒæ›´æ–°ã€‚ç­‰å¾…å¤§çº¦ 10sï¼Œå°±å¯ä»¥å°è¯•è®¿é—® <strong>k8s-dashboard.domain.com</strong> äº†ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯ç†Ÿæ‚‰çš„ kubernetes dashboard.</p>

<h2 id="ingress-çš„-tls-é…ç½®">Ingress çš„ TLS é…ç½®</h2>

<p>ç”±äº HTTP å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“é­å—ä¸­é—´äººæ”»å‡»ï¼Œç°åœ¨çš„ç½‘ç«™æµè¡Œ HTTPS è®¤è¯ï¼Œåœ¨æ­¤ä¸º <strong>k8s-dashboard.domain.com</strong> åŠ ä¸Š <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>ï¼Œç‚¹äº® HTTPS çš„ç»¿ç¯ã€‚</p>

<p>HTTPS è¯ä¹¦éœ€è¦è´­ä¹°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Let&rsquo;s Encrypt æä¾›çš„å…è´¹ HTTPS è¯ä¹¦ã€‚<a href="https://github.com/jetstack/kube-lego">kube-lego</a> å¯ä»¥ç®€åŒ–ä» Let&rsquo;s Encrypt è·å–è¯ä¹¦çš„æµç¨‹ã€‚ä½†ç”±äº Let&rsquo;s Encrypt æ¯90å¤©éœ€è¦æ›´æ–°ä¸€æ¬¡è¯ä¹¦ï¼Œè¿˜å¯èƒ½ä¼šå‡ºç°å› ä¸ºè·å–è¯ä¹¦é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè·å–ä¸åˆ°è¯ä¹¦ï¼Œä»è€Œåªèƒ½å¹²ç­‰çš„çŠ¶å†µï¼Œæ‰€ä»¥ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä½¿ç”¨è´­ä¹°çš„ HTTPS è¯ä¹¦ã€‚</p>

<p>è´­ä¹°çš„ HTTPS è¯ä¹¦ä¸€èˆ¬ä¼šæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œdomain.key å’Œ domain.pem</p>

<ul>
<li>åˆ›å»º TLS secret</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create secret tls domain-tls --cert=path/to/domain.pem --key=path/to/domain.key</code></pre></div>
<ul>
<li>åˆ›å»ºå¥½ domain-tls çš„ secret åï¼Œæ›´æ–° Ingress è§„åˆ™ï¼ŒåŠ ä¸Š TLS é…ç½®</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-with-tls.yaml</code></pre></div>
<p>HTTPS ç”Ÿæ•ˆå¤§æ¦‚éœ€è¦1åˆ†é’Ÿï¼Œä¹‹åè®¿é—® <strong>k8s-dashboard.domain.com</strong>ï¼Œç»¿è‰²çš„ HTTPS è®¤è¯å°±å‡ºç°äº†ã€‚</p>

<h2 id="ingress-çš„-basic-auth-é…ç½®">Ingress çš„ basic auth é…ç½®</h2>

<p>åŠ å…¥ TLS åŠ å¯†ä¹‹åï¼Œä¿è¯äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®ä¼ è¾“æ˜¯å—ä¿æŠ¤çš„ï¼Œä½†æ˜¯ç°åœ¨ä»»ä½•ä¸€ä¸ªäººéƒ½å¯ä»¥é€šè¿‡ <strong>k8s-dashboard.domain.com</strong> è®¿é—®å¹¶æ§åˆ¶ kubernetes é›†ç¾¤ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ï¼Œéœ€è¦åŠ ä¸Šæƒé™éªŒè¯ã€‚</p>

<p>ç®€å•èµ·è§ï¼Œä»¥ basic-auth ä¸ºä¾‹</p>

<ul>
<li>åˆ›å»º basic auth æ–‡ä»¶ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªåä¸º authï¼Œç”¨æˆ·åæ˜¯ fooï¼Œå¯†ç æ˜¯è¾“å…¥çš„å¯†ç çš„ basic auth æ–‡ä»¶ã€‚Windows ä¸‹æ²¡æœ‰ htpasswdï¼Œå¯ä»¥ä½¿ç”¨ Windows Subsystem for Linux æ¥ç”Ÿæˆï¼Œè¯¦æƒ…è¯·å‚è€ƒ <a href="http://studymakesmehappy.club/posts/set-up-development-environment-on-windows/">Set Up Development Environment on Windows</a></li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ htpasswd -c auth foo
New password: &lt;bar&gt;
New password:
Re-type new password:
Adding password <span style="color:#6ab825;font-weight:bold">for</span> user foo</code></pre></div>
<ul>
<li>åˆ›å»º basic auth çš„ secret</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create secret generic basic-auth --from-file=auth</code></pre></div>
<ul>
<li>æ›´æ–° Ingressï¼Œåœ¨ annotation ä¸­åŠ å…¥ basic auth çš„é…ç½®</li>
</ul>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-with-tls-and-basic-auth.yaml</code></pre></div>
<p>ä¹Ÿæ˜¯å¤§æ¦‚éœ€è¦ç­‰1åˆ†é’Ÿï¼Œä¹‹åè®¿é—® k8s-dashboard.ruffcorp.com éƒ½éœ€è¦è¾“å…¥å¯†ç ã€‚</p>

<h2 id="ingress-çš„å±€é™">Ingress çš„å±€é™</h2>

<p>ç”±äº nginx æ˜¯ç¬¬7å±‚(Application Layer In <a href="https://en.wikipedia.org/wiki/OSI_model">OSI network model</a>)çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè™½è¯´ nginx æœ‰ TCP æ’ä»¶ï¼Œå¯ä»¥è½¬å‘ç¬¬3å±‚ï¼ˆNetwork Layerï¼‰çš„ TCP è¿æ¥ï¼Œä½† Ingress-nginx å¯¹ <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/exposing-tcp-udp-services.md">TCP è¯·æ±‚çš„è½¬å‘è§„åˆ™çš„æ”¯æŒ</a> å¯èƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªç¯å¢ƒâ€”â€”Production, Staging å’Œ Testï¼Œä¸‰ä¸ªç¯å¢ƒä¸‹éƒ½æœ‰ä¸€ä¸ª tcp æœåŠ¡ï¼Œåœ¨ 443 ç«¯å£æä¾›æœåŠ¡ã€‚å®ƒä»¬åŸŸååˆ†åˆ«ä¸º:</p>

<ul>
<li>tcp.domain.com</li>
<li>staging-tcp.domain.com</li>
<li>test-tcp.domain.com</li>
</ul>

<p>ç”±äº Ingress-nginx åªèƒ½æ ¹æ®ç«¯å£æ¥è½¬å‘ tcp è¯·æ±‚ï¼Œè€Œä¸æ˜¯ <strong>åŸŸå:ç«¯å£</strong> çš„å½¢å¼</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#3677a9">443</span>: production/tcp-service</code></pre></div>
<p>ä½†æ˜¯è¿™ä¸‰ä¸ªç¯å¢ƒä¸‹çš„ tcp æœåŠ¡çš„ç«¯å£éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µ</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#3677a9">443</span>: production/tcp-service
<span style="color:#3677a9">443</span>: staging/tcp-service
<span style="color:#3677a9">443</span>: test/tcp-service</code></pre></div>
<p>æ˜¾ç„¶ Ingress nginx æ— æ³•è¯†åˆ«è¿™æ ·çš„è§„åˆ™ã€‚</p>

<p>å‡å¦‚ tcp çš„è§„åˆ™å¯ä»¥è¿™æ ·è®¾ç½®ï¼š</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ed9d13">&#34;tcp.domain.com:443&#34;</span>: production/tcp-service
<span style="color:#ed9d13">&#34;staging-tcp.domain.com:443&#34;</span>: staging/tcp-service
<span style="color:#ed9d13">&#34;test-tcp.domain.com:443&#34;</span>: test/tcp-service</code></pre></div>
<p>é‚£ä¹ˆ nginx å°±èƒ½æ»¡è¶³æˆ‘ä»¬3ä¸ªç¯å¢ƒçš„éœ€æ±‚äº†ï¼Œä½†ç›®å‰è¿™åªæ˜¯æˆ‘çš„ä¸€ä¸ªè®¾æƒ³ï¼Œä¼šæ‰¾æ—¶é—´è¯¢é—® Kubernetes ç¤¾åŒºï¼Œå¹¶å‘èµ· pull requestã€‚</p>

<p>åœ¨ä¸Šè¿°æƒ³æ³•è¿˜æœªå®ç°çš„æƒ…å†µä¸‹ï¼Œé’ˆå¯¹è¿™3ä¸ªç¯å¢ƒä¸‹çš„ tcp æœåŠ¡ï¼Œç±»ä¼¼äº ingress nginx çš„æ–¹å¼ï¼Œå¯ä»¥å•ç‹¬é€šè¿‡ LoadBalancer ç±»å‹çš„ Service å¯¹å¤–æš´éœ²ï¼Œè·å–åˆ°å¤–éƒ¨ IP ä¹‹åï¼Œå†æ‰‹åŠ¨è®¾ç½® DNS è§£æã€‚</p>

<p>æœ‰é—®é¢˜æ¬¢è¿ pingğŸ˜</p>

</div>


    
<footer class='entry-footer'>
  
    
      
      

<div class='categories'>
  <span class='category-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>

  </span>
  <span class='screen-reader'>Categories: </span><a class='category' href='http://excited-ccccly.github.io/studymakesmehappy.club/categories/devops'>DevOps</a></div>


    
  
    
      
      

<div class='tags'>
  <span class='tag-icon'>
    <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>

  </span>
  <span class='screen-reader'>Tags: </span><a class='tag' href='http://excited-ccccly.github.io/studymakesmehappy.club/tags/kubernetes'>Kubernetes</a>, <a class='tag' href='http://excited-ccccly.github.io/studymakesmehappy.club/tags/ingress'>Ingress</a>, <a class='tag' href='http://excited-ccccly.github.io/studymakesmehappy.club/tags/nginx'>nginx</a>, <a class='tag' href='http://excited-ccccly.github.io/studymakesmehappy.club/tags/loadbalancer'>Loadbalancer</a></div>


    
  
</footer>



  </article>

  
    
<nav class='entry-nav'>
  <div class='entry-nav-links'><div class='prev-entry'>
      <a href='http://excited-ccccly.github.io/studymakesmehappy.club/posts/set-up-development-environment-on-windows/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader'>Previous post: </span>Set Up Development Environment on Windows</a>
    </div></div>
</nav>


  

  
    <div class='comments-container'>
</div>

  
</main>

    <footer id='footer' class='footer-container'>
      <div class='footer'>
        <div class='social'>
  <nav aria-label='Social Menu'>
    <ul class='social-menu'><li>
        <a href='https://github.com/Excited-ccccly' target='_blank' rel='noopener'>
          <span class='screen-reader'>Open Github account in new tab</span>
          <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>

        </a>
      </li></ul>
  </nav>
</div>

        <div class='copyright'>
          <p>
    
      
    
  
  &copy; 2017-2018 ccccly</p>


        </div>
      </div>
    </footer>

  </div>

  <script src='http://excited-ccccly.github.io/studymakesmehappy.club/js/main.af838dd5.js'></script>
  

</body>

</html>

