<!DOCTYPE html>
<html lang='zh'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='kubernetes101 ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE express-app NodePort 10.0.0.151 &lt;none&gt; 80:31530/TCP 19m kubernetes ClusterIP 10.0.0.1 &lt;none&gt; 443/TCP 1d è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ NodeIP:NodePort æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Kubernetes Ingress â€¢ ccccly'>
<meta property='og:description' content='kubernetes101 ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚ NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE express-app NodePort 10.0.0.151 &lt;none&gt; 80:31530/TCP 19m kubernetes ClusterIP 10.0.0.1 &lt;none&gt; 443/TCP 1d è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ NodeIP:NodePort æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†'>
<meta property='og:url' content='https://studymakesmehappy.club/posts/kubernetes-ingress/'>
<meta property='og:site_name' content='Home'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/374150c4ee619dfed2491b9bb5bcd476?s=256'><meta property='article:section' content='posts'><meta property='article:tag' content='Kubernetes'><meta property='article:tag' content='Ingress'><meta property='article:tag' content='nginx'><meta property='article:tag' content='Loadbalancer'><meta property='article:published_time' content='2018-03-27T15:27:27&#43;08:00'/><meta property='article:modified_time' content='2018-03-27T15:27:27&#43;08:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.56.3" />

  <title>Kubernetes Ingress â€¢ ccccly</title>
  <link rel='canonical' href='https://studymakesmehappy.club/posts/kubernetes-ingress/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129765949-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-posts'>

  <div class='site'><a class='screen-reader-text' href='#content'>è·³åˆ°æ–‡ç« </a><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='ä¸»èœå•'>
  <div class='container'>
    
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/posts/'>Posts</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li><li class='item'>
        <a href='https://github.com/Excited-ccccly/studymakesmehappy.club'>Repo</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Home</p><p class='desc site-desc'>Study makes me happy</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='zh' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Kubernetes Ingress</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>å‘å¸ƒ </span>
  <time class='entry-date' datetime='2018-03-27T15:27:27&#43;08:00'>2018, Mar 27</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/ccccly'>ccccly</a></span>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
éœ€è¦4åˆ†é’Ÿè¯»å®Œ
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  

<p><a href="https://studymakesmehappy.club/posts/kubernetes101/" target="_blank">kubernetes101</a> ä»‹ç»äº† Kubernetes çš„åŸºæœ¬ç”¨æ³•ï¼Œé€šè¿‡ NodePort çš„å½¢å¼å¯¹å¤–æš´éœ² Service æ¥æä¾›æœåŠ¡ã€‚</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
express-app   NodePort    <span style="color:#3677a9">10</span>.0.0.151   &lt;none&gt;        <span style="color:#3677a9">80</span>:31530/TCP   19m
kubernetes    ClusterIP   <span style="color:#3677a9">10</span>.0.0.1     &lt;none&gt;        <span style="color:#3677a9">443</span>/TCP        1d</code></pre></div>
<p>è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ <strong>NodeIP:NodePort</strong> æ¥ä»å¤–ç•Œè®¿é—®è¿™ä¸ªæœåŠ¡ï¼Œå…¶ä¸­ 192.168.99.100 æ˜¯é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ª Node èŠ‚ç‚¹çš„ IP</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl http://192.168.99.100:31530
hello world</code></pre></div>
<p>ä½†æ¯æ¬¡ä½¿ç”¨ IP+Port è®¿é—®æœåŠ¡çš„æ–¹å¼å¾ˆä¸æ–¹ä¾¿ã€‚åœ¨å•æœºä¸Šï¼Œå¯ä»¥ä½¿ç”¨ nginx çš„åå‘ä»£ç†ï¼Œå®ç°é€šè¿‡åŸŸåè®¿é—®æœåŠ¡ã€‚</p>

<p>nginx.conf</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">http {
  upstream my-api {
    server <span style="color:#3677a9">127</span>.0.0.1:8080;
  }

  server {
    listen <span style="color:#3677a9">80</span>;
    server_name api.domain.com;
    location / {
      proxy_pass http://my-api;
    }
  }
}</code></pre></div>
<p>å¯ç”¨ nginx åï¼Œå°±å¯ä»¥é€šè¿‡è®¿é—® <a href="http://api.domain.com" target="_blank">http://api.domain.com</a> æ¥è®¿é—®è¿™å°æœºå­ä¸Šç›‘å¬ 8080 ç«¯å£çš„æœåŠ¡ã€‚</p>

<p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼ŒIngress å¯ä»¥è¯´æ˜¯å¯¹ nginx çš„æŠ½è±¡ï¼ˆæ¥å£ï¼‰ï¼Œ<a href="https://github.com/kubernetes/ingress-nginx" target="_blank">ingress-nginx</a> æ˜¯ Ingress çš„ä¸€ç§å®ç°ã€‚</p>

<p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œå‡è®¾ä½ å­¦ä¹ è¿‡ <a href="https://studymakesmehappy.club/posts/kubernetes101/" target="_blank">kubernetes101</a>ï¼Œä½ å°†ä¼šå­¦ä¹ åˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<ul>
<li>Ingress ä»‹ç»</li>
<li>Ingress çš„åŸºç¡€é…ç½®</li>
<li>Ingress çš„ TLS é…ç½®</li>
<li>Ingress çš„ basic auth é…ç½®</li>
<li>Ingress çš„å±€é™</li>
</ul>

<h2 id="ingress-ä»‹ç»">Ingress ä»‹ç»</h2>

<p>åœ¨ Kubernetes ä¸­ï¼Œé€šè¿‡ Ingress è®¿é—®åº”ç”¨çš„æµç¨‹å¤§è‡´ä¸Šæ˜¯è¿™æ ·å­çš„</p>

<p><img src="/images/kubernetes/ingress/ingress.png" alt="æ±‚æ¨èå¥½ç”¨çš„ç”»å›¾å·¥å…·ï¼ŒVisio å¥½éš¾ç”¨..." /></p>

<p>é™¤äº† Ingress æš´éœ²åœ¨å…¬ç½‘ä¸­ï¼Œå…¶å®ƒæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯å†…ç½‘ IPï¼Œåªå…è®¸å†…ç½‘è®¿é—®ã€‚</p>

<ul>
<li>External LoadBalancer æ˜¯äº‘æœåŠ¡å‚å•†æä¾›çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæ¯”å¦‚ Azure LoadBalancer, AWS ELB ç­‰ã€‚</li>
<li>Ingress Controller æ ¹æ®å®šä¹‰çš„ Ingress è§„åˆ™ï¼Œæ¥è½¬å‘ä¸åŒçš„è¯·æ±‚åˆ°ä¸åŒçš„ Service ä¸Šï¼Œå°±åƒ nginx çš„åå‘ä»£ç†ä¸€æ ·ã€‚</li>
<li>Default Backend æ˜¯é»˜è®¤çš„åç«¯ï¼Œä½†æœ‰ä¸€ä¸ªæœªçŸ¥çš„åŸŸå(ingress ä¸­æ²¡æœ‰å®šä¹‰)çš„è¯·æ±‚è¿‡æ¥ï¼Œå°†ä¼šè¿”å› default backend æä¾›çš„å†…å®¹ã€‚</li>
</ul>

<p>ä¸€ä¸ªç®€å•çš„ Ingress è§„åˆ™é•¿è¿™æ ·å­</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-YAML" data-lang="YAML">apiVersion:<span style="color:#666"> </span>v1<span style="color:#666">
</span><span style="color:#666"></span>items:<span style="color:#666">
</span><span style="color:#666"></span>-<span style="color:#666"> </span>apiVersion:<span style="color:#666"> </span>extensions/v1beta1<span style="color:#666">
</span><span style="color:#666">  </span>kind:<span style="color:#666"> </span>Ingress<span style="color:#666">
</span><span style="color:#666">  </span>metadata:<span style="color:#666">
</span><span style="color:#666">    </span>name:<span style="color:#666"> </span>kube-system.ingress<span style="color:#666">
</span><span style="color:#666">    </span>namespace:<span style="color:#666"> </span>kube-system<span style="color:#666">
</span><span style="color:#666">  </span>spec:<span style="color:#666">
</span><span style="color:#666">    </span>rules:<span style="color:#666">
</span><span style="color:#666">    </span>-<span style="color:#666"> </span>host:<span style="color:#666"> </span>website1.domain.com<span style="color:#666">
</span><span style="color:#666">      </span>http:<span style="color:#666">
</span><span style="color:#666">        </span>paths:<span style="color:#666">
</span><span style="color:#666">        </span>-<span style="color:#666"> </span>backend:<span style="color:#666">
</span><span style="color:#666">            </span>serviceName:<span style="color:#666"> </span>website1<span style="color:#666">
</span><span style="color:#666">            </span>servicePort:<span style="color:#666"> </span><span style="color:#3677a9">80</span><span style="color:#666">
</span><span style="color:#666">          </span>path:<span style="color:#666"> </span>/<span style="color:#666">
</span><span style="color:#666"></span>kind:<span style="color:#666"> </span>List</code></pre></div>
<p>æ­¤é¡¹è§„åˆ™å°† website1.domain.com çš„è¯·æ±‚å…¨éƒ¨è½¬å‘åˆ° website1 æœåŠ¡å¯¹åº”çš„ Pod ä¸­ã€‚</p>

<h2 id="ingress-çš„åŸºç¡€é…ç½®">Ingress çš„åŸºç¡€é…ç½®</h2>

<p>æ¥ä¸‹æ¥åŠ¨æ‰‹é…ç½®ä¸€ä¸ª Kubernetes é›†ç¾¤çš„ Ingressã€‚</p>

<blockquote>
<p>ç”±äºä»¥ä¸‹çš„æ­¥éª¤è¦æ±‚éƒ¨ç½²çš„ Kubernetes æ”¯æŒäº‘å‚å•†æä¾›çš„å¤–éƒ¨ LoadBalancerï¼Œç±»ä¼¼äº minikube ä¹‹ç±»çš„ç¯å¢ƒæ˜¯ä¸æ”¯æŒå¤–éƒ¨ LoadBalancer çš„ï¼Œè¯·çŸ¥æ™“ã€‚</p>
</blockquote>

<p>ä¸ºäº†æ–¹ä¾¿å±•ç¤ºï¼Œä»¥ä¸‹æ‰€æœ‰ä½¿ç”¨åˆ°çš„é…ç½®æ–‡ä»¶éƒ½ä½¿ç”¨ç½‘ç»œåœ°å€ï¼Œä¸æ˜¾ç¤ºå®é™…çš„å†…å®¹ï¼Œå¯ä»¥å•ç‹¬ä¸‹è½½æ–‡ä»¶æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥å‰å¾€ <a href="https://github.com/Excited-ccccly/studymakesmehappy.club/tree/master/static/files/kubernetes/ingress" target="_blank">ingress é…ç½®æ–‡ä»¶å¤¹</a> æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶</p>

<ul>
<li><p>ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬ä¸º Ingress å•ç‹¬åˆ›å»ºä¸€ä¸ª namespace</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/01-namespace.yaml</code></pre></div></li>

<li><p>åˆ›å»ºé»˜è®¤çš„ http åç«¯ï¼ŒIngress æ¥æ”¶åˆ°ä¸€ä¸ª 404 çš„åœ°å€ï¼Œäº¤ç»™è¿™ä¸ªåç«¯æ¥å¤„ç†</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/02-default-backend.yaml</code></pre></div></li>

<li><p>åˆ›å»º ingress nginx æ‰€éœ€çš„é…ç½®æ–‡ä»¶ã€‚é»˜è®¤çš„é…ç½®é™åˆ¶ body size ä¸º 1mï¼Œè¿™é‡Œç¨å¾®è°ƒå¤§ä¸€äº›ï¼Œæ–¹ä¾¿æ–‡ä»¶ä¸Šä¼ </p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/03-configmap.yaml</code></pre></div></li>

<li><p>åˆ›å»º ingress nginx æœåŠ¡</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/04-ingress-nginx.yaml</code></pre></div></li>

<li><p>é€šè¿‡ LoadBalancer çš„æ–¹å¼å¯¹å¤–æš´éœ² ingress nginx æœåŠ¡</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/05-service.yaml</code></pre></div></li>
</ul>

<p>è·å– ingress nginx æœåŠ¡çš„å¤–éƒ¨ LoadBalancer çš„åœ°å€</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">  kubectl get svc --namespace ingress-nginx</code></pre></div>
<ul>
<li><p>å°†åŸŸåè§£æåˆ°å¤–éƒ¨çš„ LoadBalancer</p>

<p>*.domain.com -&gt; IngressNginxExternalLoadBalancerIP</p></li>

<li><p>åˆ›å»ºä¸€æ¡ Ingress è§„åˆ™(æš‚æ—¶ä¸å¸¦ TLS å’Œ Basic Auth)ï¼Œå°† <strong>k8s-dashboard.domain.com</strong> è½¬å‘è‡³ kubernetes-dashboard æœåŠ¡å¯¹åº”çš„ Pod ä¸­ã€‚</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-without-neither-tls-or-basic-auth.yaml</code></pre></div></li>
</ul>

<p>ingress-controller ä¼šç›‘å¬é›†ç¾¤ä¸­æ‰€æœ‰ Ingress è§„åˆ™çš„å˜åŠ¨ï¼Œä¿æŒæ›´æ–°ã€‚ç­‰å¾…å¤§çº¦ 10sï¼Œå°±å¯ä»¥å°è¯•è®¿é—® <strong>k8s-dashboard.domain.com</strong> äº†ï¼Œçœ‹çœ‹æ˜¯å¦æ˜¯ç†Ÿæ‚‰çš„ kubernetes dashboard.</p>

<h2 id="ingress-çš„-tls-é…ç½®">Ingress çš„ TLS é…ç½®</h2>

<p>ç”±äº HTTP å¾ˆä¸å®‰å…¨ï¼Œå®¹æ˜“é­å—ä¸­é—´äººæ”»å‡»ï¼Œç°åœ¨çš„ç½‘ç«™æµè¡Œ HTTPS è®¤è¯ï¼Œåœ¨æ­¤ä¸º <strong>k8s-dashboard.domain.com</strong> åŠ ä¸Š <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">TLS</a>ï¼Œç‚¹äº® HTTPS çš„ç»¿ç¯ã€‚</p>

<p>HTTPS è¯ä¹¦éœ€è¦è´­ä¹°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Let&rsquo;s Encrypt æä¾›çš„å…è´¹ HTTPS è¯ä¹¦ã€‚<a href="https://github.com/jetstack/kube-lego" target="_blank">kube-lego</a> å¯ä»¥ç®€åŒ–ä» Let&rsquo;s Encrypt è·å–è¯ä¹¦çš„æµç¨‹ã€‚ä½†ç”±äº Let&rsquo;s Encrypt æ¯90å¤©éœ€è¦æ›´æ–°ä¸€æ¬¡è¯ä¹¦ï¼Œè¿˜å¯èƒ½ä¼šå‡ºç°å› ä¸ºè·å–è¯ä¹¦é”™è¯¯æ¬¡æ•°è¿‡å¤šï¼Œè·å–ä¸åˆ°è¯ä¹¦ï¼Œä»è€Œåªèƒ½å¹²ç­‰çš„çŠ¶å†µï¼Œæ‰€ä»¥ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä½¿ç”¨è´­ä¹°çš„ HTTPS è¯ä¹¦ã€‚</p>

<p>è´­ä¹°çš„ HTTPS è¯ä¹¦ä¸€èˆ¬ä¼šæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œdomain.key å’Œ domain.pem</p>

<ul>
<li><p>åˆ›å»º TLS secret</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create secret tls domain-tls --cert=path/to/domain.pem --key=path/to/domain.key</code></pre></div></li>

<li><p>åˆ›å»ºå¥½ domain-tls çš„ secret åï¼Œæ›´æ–° Ingress è§„åˆ™ï¼ŒåŠ ä¸Š TLS é…ç½®</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-with-tls.yaml</code></pre></div></li>
</ul>

<p>HTTPS ç”Ÿæ•ˆå¤§æ¦‚éœ€è¦1åˆ†é’Ÿï¼Œä¹‹åè®¿é—® <strong>k8s-dashboard.domain.com</strong>ï¼Œç»¿è‰²çš„ HTTPS è®¤è¯å°±å‡ºç°äº†ã€‚</p>

<h2 id="ingress-çš„-basic-auth-é…ç½®">Ingress çš„ basic auth é…ç½®</h2>

<p>åŠ å…¥ TLS åŠ å¯†ä¹‹åï¼Œä¿è¯äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®ä¼ è¾“æ˜¯å—ä¿æŠ¤çš„ï¼Œä½†æ˜¯ç°åœ¨ä»»ä½•ä¸€ä¸ªäººéƒ½å¯ä»¥é€šè¿‡ <strong>k8s-dashboard.domain.com</strong> è®¿é—®å¹¶æ§åˆ¶ kubernetes é›†ç¾¤ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ï¼Œéœ€è¦åŠ ä¸Šæƒé™éªŒè¯ã€‚</p>

<p>ç®€å•èµ·è§ï¼Œä»¥ basic-auth ä¸ºä¾‹</p>

<ul>
<li><p>åˆ›å»º basic auth æ–‡ä»¶ï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªåä¸º authï¼Œç”¨æˆ·åæ˜¯ fooï¼Œå¯†ç æ˜¯è¾“å…¥çš„å¯†ç çš„ basic auth æ–‡ä»¶ã€‚Windows ä¸‹æ²¡æœ‰ htpasswdï¼Œå¯ä»¥ä½¿ç”¨ Windows Subsystem for Linux æ¥ç”Ÿæˆï¼Œè¯¦æƒ…è¯·å‚è€ƒ <a href="https://studymakesmehappy.club/posts/set-up-development-environment-on-windows/" target="_blank">Set Up Development Environment on Windows</a></p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ htpasswd -c auth foo
New password: &lt;bar&gt;
New password:
Re-type new password:
Adding password <span style="color:#6ab825;font-weight:bold">for</span> user foo</code></pre></div></li>

<li><p>åˆ›å»º basic auth çš„ secret</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl create secret generic basic-auth --from-file=auth</code></pre></div></li>

<li><p>æ›´æ–° Ingressï¼Œåœ¨ annotation ä¸­åŠ å…¥ basic auth çš„é…ç½®</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl apply -f  https://raw.githubusercontent.com/Excited-ccccly/studymakesmehappy.club/master/static/files/kubernetes/ingress/06-k8s-dashboard-ingress-with-tls-and-basic-auth.yaml</code></pre></div></li>
</ul>

<p>ä¹Ÿæ˜¯å¤§æ¦‚éœ€è¦ç­‰1åˆ†é’Ÿï¼Œä¹‹åè®¿é—® k8s-dashboard.ruffcorp.com éƒ½éœ€è¦è¾“å…¥å¯†ç ã€‚</p>

<h2 id="ingress-çš„å±€é™">Ingress çš„å±€é™</h2>

<p>é€šå¸¸æ¥è¯´ï¼Œnginx æ˜¯ç¬¬7å±‚(Application Layer In <a href="https://en.wikipedia.org/wiki/OSI_model" target="_blank">OSI network model</a>)çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè™½è¯´ nginx æœ‰ TCP æ’ä»¶ï¼Œå¯ä»¥è½¬å‘ç¬¬4å±‚ï¼ˆTransport Layer Layerï¼‰çš„ TCP è¿æ¥ï¼Œä½† Ingress-nginx å¯¹ <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/exposing-tcp-udp-services.md" target="_blank">TCP è¯·æ±‚çš„è½¬å‘è§„åˆ™çš„æ”¯æŒ</a> å¯èƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªç¯å¢ƒâ€”â€”Production, Staging å’Œ Testï¼Œä¸‰ä¸ªç¯å¢ƒå¯¹åº”3ä¸ªå‘½åç©ºé—´(namespace)ï¼Œä¸‰ä¸ªç¯å¢ƒä¸‹éƒ½æœ‰ä¸€ä¸ª tcp æœåŠ¡ï¼Œåœ¨443ç«¯å£æä¾›æœåŠ¡ã€‚å®ƒä»¬åŸŸååˆ†åˆ«ä¸º:</p>

<ul>
<li>tcp.domain.com</li>
<li>staging-tcp.domain.com</li>
<li>test-tcp.domain.com</li>
</ul>

<p>ç”±äº Ingress-nginx åªèƒ½æ ¹æ®ç«¯å£æ¥è½¬å‘ tcp è¯·æ±‚ï¼Œè€Œä¸æ˜¯ <strong>åŸŸå:ç«¯å£</strong> çš„å½¢å¼</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#3677a9">443</span>: production/tcp-service</code></pre></div>
<p>ä½†æ˜¯è¿™ä¸‰ä¸ªç¯å¢ƒä¸‹çš„ tcp æœåŠ¡çš„ç«¯å£éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µ</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#3677a9">443</span>: production/tcp-service
<span style="color:#3677a9">443</span>: staging/tcp-service
<span style="color:#3677a9">443</span>: test/tcp-service</code></pre></div>
<p>æ˜¾ç„¶ Ingress nginx æ— æ³•è¯†åˆ«è¿™æ ·çš„è§„åˆ™ã€‚</p>

<p>å‡å¦‚ tcp çš„è§„åˆ™å¯ä»¥è¿™æ ·è®¾ç½®ï¼š</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#ed9d13">&#34;tcp.domain.com:443&#34;</span>: production/tcp-service
<span style="color:#ed9d13">&#34;staging-tcp.domain.com:443&#34;</span>: staging/tcp-service
<span style="color:#ed9d13">&#34;test-tcp.domain.com:443&#34;</span>: test/tcp-service</code></pre></div>
<p>é‚£ä¹ˆ nginx å°±èƒ½æ»¡è¶³æˆ‘ä»¬3ä¸ªç¯å¢ƒçš„éœ€æ±‚äº†ã€‚ä½†è¿™æ˜¯æ— æ³•å®ç°çš„ï¼Œåœ¨ TCP å±‚æ²¡æœ‰ host åŸŸåä¿¡æ¯ï¼Œæ‰€ä»¥è¿™ä¸ªè®¾æƒ³æ˜¯æ— æ³•åšåˆ°çš„ã€‚</p>

<p>é’ˆå¯¹è¿™3ä¸ªç¯å¢ƒä¸‹çš„ tcp æœåŠ¡ï¼Œç±»ä¼¼äº ingress nginx çš„æ–¹å¼ï¼Œå¯ä»¥å•ç‹¬é€šè¿‡ LoadBalancer ç±»å‹çš„ Service å¯¹å¤–æš´éœ²ï¼Œè·å–åˆ°å¤–éƒ¨ IP ä¹‹åï¼Œå†æ‰‹åŠ¨è®¾ç½® DNS è§£æã€‚</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl --namespace=production expose deploy tcp-service --type=LoadBalancer --port=<span style="color:#3677a9">80</span> --target-port=<span style="color:#3677a9">80</span> </code></pre></div>
<p>è·å– tcp-service æœåŠ¡çš„å¤–éƒ¨ LoadBalancer çš„åœ°å€</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl get svc --namespace ingress-nginx</code></pre></div>
<p>å°†åŸŸåè§£æåˆ°å¤–éƒ¨çš„ LoadBalancer</p>

<p>tcp.domain.com -&gt; TcpServiceExternalLoadBalancerIP</p>

<p>æœ‰é—®é¢˜æ¬¢è¿ pingğŸ˜</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>åˆ†ç±»: </span><a class='category' href='/categories/devops/'>DevOps</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>æ ‡ç­¾: </span><a class='tag' href='/tags/kubernetes/'>Kubernetes</a>, <a class='tag' href='/tags/ingress/'>Ingress</a>, <a class='tag' href='/tags/nginx/'>nginx</a>, <a class='tag' href='/tags/loadbalancer/'>Loadbalancer</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/posts/set-up-development-environment-on-windows/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 ä¸Šä¸€ä¸ª</span>
        <span class='screen-reader-text'>ä¸Šä¸€ç¯‡æ–‡ç« : </span>Set Up Development Environment on Windows</a>
    </div><div class='next-entry sep-before'>
      <a href='/posts/%E8%81%8A%E4%B8%80%E8%81%8A%E5%8F%A4%E8%80%81%E7%9A%84-x-www-form-urlencoded/'>
        <span class='screen-reader-text'>ä¸‹ä¸€ç¯‡æ–‡ç« : </span>èŠä¸€èŠå¤è€çš„ x-www-form-urlencoded<span aria-hidden='true'>ä¸‹ä¸€ä¸ª <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><script src='https://utteranc.es/client.js'
  repo='Excited-ccccly/studymakesmehappy.club' issue-term='title'
  crossorigin='anonymous' async>
</script>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='ç¤¾äº¤èœå•'>
    <ul><li>
        <a href='https://github.com/Excited-ccccly' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>åœ¨æ–°æ ‡ç­¾æ‰“å¼€Githubçš„è´¦æˆ·</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:geekchenlingyun@outlook.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>é€šè¿‡é‚®ä»¶è”ç³»</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2017-2019 ccccly </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script><script src='/js/custom.js'></script>

</body>

</html>

